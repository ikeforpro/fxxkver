<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with Friends (Channels)</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #e5e5e5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }

        /* 로그인 화면 스타일 */
        #authSection { width: 350px; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        .auth-input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .auth-btn { width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 5px; }
        .login-btn { background: #0084ff; color: white; }
        .signup-btn { background: #f8f9fa; border: 1px solid #ddd; color: #333; }

        /* 메인 채팅 레이아웃 */
        .messenger { width: 800px; height: 600px; background: white; border-radius: 15px; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }

        .sidebar { width: 260px; border-right: 1px solid #eee; background: #f8f9fa; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; font-weight: bold; font-size: 1.2rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }

        .add-channel-btn { font-size: 1.2rem; cursor: pointer; color: #0084ff; border: none; background: none; font-weight: bold; }
        .logout-btn { font-size: 0.7rem; cursor: pointer; color: #ff6b6b; border: 1px solid #ff6b6b; padding: 3px 8px; border-radius: 5px; }

        .friend-list { flex: 1; overflow-y: auto; }
        .friend-item { padding: 15px 20px; display: flex; align-items: center; cursor: pointer; transition: 0.2s; border-bottom: 1px solid #f1f1f1; }
        .friend-item:hover { background: #f1f1f1; }
        .friend-item.active { background: #e7f1ff; color: #0084ff; font-weight: bold; }

        .profile-img { width: 35px; height: 35px; border-radius: 50%; background: #3498db; margin-right: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; }

        .chat-area { flex: 1; display: flex; flex-direction: column; }
        .chat-header { padding: 15px 25px; border-bottom: 1px solid #eee; font-weight: bold; display: flex; align-items: center; background: #fff; }
        .status-dot { width: 8px; height: 8px; background: #2ecc71; border-radius: 50%; margin-left: 8px; }

        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; background: #fff; }
        .msg-container { display: flex; flex-direction: column; max-width: 70%; }
        .msg-container.sent { align-self: flex-end; align-items: flex-end; }
        .msg-container.received { align-self: flex-start; align-items: flex-start; }

        .nickname { font-size: 0.75rem; color: #888; margin-bottom: 4px; }
        .msg { padding: 10px 14px; border-radius: 18px; font-size: 0.9rem; word-break: break-all; }
        .msg.received { background: #f1f0f0; border-top-left-radius: 2px; }
        .msg.sent { background: #0084ff; color: white; border-top-right-radius: 2px; }

        .input-box { padding: 20px; border-top: 1px solid #eee; display: flex; gap: 10px; background: #fff; }
        .input-box input { flex: 1; border: none; background: #f1f0f0; padding: 12px 18px; border-radius: 25px; outline: none; }
        .input-box button { background: #0084ff; color: white; border: none; padding: 0 20px; border-radius: 20px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div id="authSection">
    <h2>반가워요!</h2>
    <p style="color: #666; font-size: 0.9rem;">채널에 참여하려면 로그인하세요.</p>
    <input type="email" id="email" class="auth-input" placeholder="이메일">
    <input type="password" id="password" class="auth-input" placeholder="비밀번호">
    <button onclick="signIn()" class="auth-btn login-btn">로그인</button>
    <button onclick="signUp()" class="auth-btn signup-btn">이메일로 회원가입</button>
</div>

<div class="messenger" id="messengerMain">
    <div class="sidebar">
        <div class="sidebar-header">
            채널 <button class="add-channel-btn" onclick="createChannel()">+</button>
            <span class="logout-btn" onclick="signOut()">로그아웃</span>
        </div>
        <div class="friend-list" id="channelList">
            </div>
    </div>

    <div class="chat-area">
        <div class="chat-header">
            <span id="currentChannelName">전체 대화방</span> <span class="status-dot"></span>
        </div>
        <div class="messages" id="msgWindow"></div>
        <div class="input-box">
            <input type="text" id="chatInput" placeholder="메시지를 입력하세요..." onkeypress="if(event.keyCode==13) send()">
            <button onclick="send()">전송</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAw7tCJOm0djyiuYv4JNmhHwP_E8BmOlVQ",
        authDomain: "my-chat-app-9ee00.firebaseapp.com",
        databaseURL: "https://my-chat-app-9ee00-default-rtdb.firebaseio.com",
        projectId: "my-chat-app-9ee00",
        storageBucket: "my-chat-app-9ee00.firebasestorage.app",
        messagingSenderId: "384196897745",
        appId: "1:384196897745:web:47328e3cbe005662690ef0"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    let currentUserEmail = "";
    let currentChannel = "public"; // 기본 채널 ID

    // --- 1. 로그인/회원가입 기능 ---
    function signUp() {
        const email = document.getElementById('email').value.trim();
        const pw = document.getElementById('password').value;
        auth.createUserWithEmailAndPassword(email, pw)
            .then(() => alert("가입을 축하합니다!"))
            .catch(err => alert("가입 실패: " + err.message));
    }

    function signIn() {
        const email = document.getElementById('email').value.trim();
        const pw = document.getElementById('password').value;
        auth.signInWithEmailAndPassword(email, pw)
            .catch(err => alert("로그인 실패: " + err.message));
    }

    function signOut() { auth.signOut(); }

    // --- 2. 로그인 상태 및 채널 감시 ---
    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('messengerMain').style.display = 'flex';
            currentUserEmail = user.email;

            loadChannels(); // 채널 목록 가져오기
            switchChannel('public', '전체 대화방'); // 기본 채널 입장
        } else {
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('messengerMain').style.display = 'none';
        }
    });

    // --- 3. 채널 관리 기능 ---
    function createChannel() {
        const name = prompt("새로운 채널 이름을 입력하세요:");
        if (name && name.trim() !== "") {
            database.ref('channels').push({
                name: name.trim(),
                creator: currentUserEmail
            });
        }
    }

    function loadChannels() {
        const list = document.getElementById('channelList');
        database.ref('channels').on('value', (snapshot) => {
            list.innerHTML = "";
            // 기본 전체 채널 추가
            addChannelItem('public', '전체 대화방');

            snapshot.forEach((child) => {
                addChannelItem(child.key, child.val().name);
            });
        });
    }

    function addChannelItem(id, name) {
        const list = document.getElementById('channelList');
        const div = document.createElement('div');
        div.className = 'friend-item' + (currentChannel === id ? ' active' : '');
        div.innerHTML = `<div class="profile-img">#</div><div><strong>${name}</strong></div>`;
        div.onclick = () => switchChannel(id, name);
        list.appendChild(div);
    }

    function switchChannel(id, name) {
        currentChannel = id;
        document.getElementById('currentChannelName').innerText = name;
        document.getElementById('msgWindow').innerHTML = ""; // 화면 초기화

        // 채널 목록 활성화 스타일 업데이트
        const items = document.querySelectorAll('.friend-item');
        items.forEach(item => item.classList.remove('active'));

        loadMessages();
    }

    // --- 4. 채팅 기능 ---
    function send() {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if (text !== "") {
            database.ref(`messages/${currentChannel}`).push({
                email: currentUserEmail,
                nickname: currentUserEmail.split('@')[0], // 이메일 앞부분을 닉네임으로
                message: text,
                timestamp: Date.now()
            });
            input.value = '';
        }
    }

    function loadMessages() {
        database.ref(`messages/${currentChannel}`).off();
        database.ref(`messages/${currentChannel}`).on('child_added', (snapshot) => {
            const data = snapshot.val();
            const window = document.getElementById('msgWindow');

            const isMe = data.email === currentUserEmail;
            const container = document.createElement('div');
            container.className = `msg-container ${isMe ? 'sent' : 'received'}`;

            // 닉네임 추가 (내가 보낸 게 아닐 때만 표시하거나 전부 표시 가능)
            const nick = document.createElement('span');
            nick.className = 'nickname';
            nick.innerText = isMe ? "나" : data.nickname;

            const msgDiv = document.createElement('div');
            msgDiv.className = `msg ${isMe ? 'sent' : 'received'}`;
            msgDiv.innerText = data.message;

            container.appendChild(nick);
            container.appendChild(msgDiv);
            window.appendChild(container);

            window.scrollTop = window.scrollHeight;
        });
    }
</script>

</body>
</html>